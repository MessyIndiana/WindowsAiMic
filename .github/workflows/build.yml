name: Build WindowsAiMic

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2
      
    - name: Clone RNNoise
      shell: pwsh
      run: |
        cd engine/libs
        if (Test-Path rnnoise/src) { Remove-Item rnnoise/src -Recurse -Force }
        if (Test-Path rnnoise/include) { Remove-Item rnnoise/include -Recurse -Force }
        git clone --depth 1 https://github.com/xiph/rnnoise.git rnnoise_temp
        New-Item -ItemType Directory -Path rnnoise/src -Force | Out-Null
        New-Item -ItemType Directory -Path rnnoise/include -Force | Out-Null
        Copy-Item rnnoise_temp/src/* rnnoise/src/ -Force
        Copy-Item rnnoise_temp/include/* rnnoise/include/ -Force
        Remove-Item rnnoise_temp -Recurse -Force
      
    - name: Configure CMake
      shell: pwsh
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DENABLE_AVX2=ON
      
    - name: Build
      shell: pwsh
      run: |
        cmake --build build --config Release --parallel
      
    - name: Create Package
      shell: pwsh
      run: |
        # Create distribution directory
        New-Item -ItemType Directory -Path dist/WindowsAiMic -Force | Out-Null
        New-Item -ItemType Directory -Path dist/WindowsAiMic/drivers -Force | Out-Null
        New-Item -ItemType Directory -Path dist/WindowsAiMic/config -Force | Out-Null
        
        # Find and copy executables
        $exeFiles = Get-ChildItem -Path build -Filter "*.exe" -Recurse
        foreach ($exe in $exeFiles) {
            Copy-Item $exe.FullName dist/WindowsAiMic/ -Force
            Write-Host "Copied: $($exe.Name)"
        }
        
        # Copy config
        Copy-Item config/default_config.json dist/WindowsAiMic/config/ -ErrorAction SilentlyContinue
        
        # Copy installer script
        Copy-Item scripts/install.ps1 dist/WindowsAiMic/
        
        # Create Install.bat
        $installBat = @'
        @echo off
        echo ============================================
        echo    WindowsAiMic One-Click Installer
        echo ============================================
        echo.
        echo This will install WindowsAiMic on your system.
        echo Administrator privileges are required.
        echo.
        pause
        powershell -ExecutionPolicy Bypass -File "%~dp0install.ps1"
        pause
        '@
        $installBat | Out-File -FilePath dist/WindowsAiMic/Install.bat -Encoding ASCII
        
        # Create Uninstall.bat
        $uninstallBat = @'
        @echo off
        echo Uninstalling WindowsAiMic...
        powershell -ExecutionPolicy Bypass -File "%~dp0install.ps1" -Uninstall
        pause
        '@
        $uninstallBat | Out-File -FilePath dist/WindowsAiMic/Uninstall.bat -Encoding ASCII
        
        # Create README
        $readme = @'
        WindowsAiMic - AI-Powered Virtual Microphone
        =============================================
        
        INSTALLATION:
        1. Right-click Install.bat -> Run as Administrator
        2. When prompted, allow VB-Cable to be downloaded
        3. Reboot if prompted
        4. Done! Look for tray icon.
        
        USAGE:
        - Right-click tray icon for settings
        - In your apps, select "CABLE Output (VB-Audio)" as microphone
        
        UNINSTALL:
        - Right-click Uninstall.bat -> Run as Administrator
        '@
        $readme | Out-File -FilePath dist/WindowsAiMic/README.txt -Encoding ASCII
        
        # List package contents
        Write-Host "`nPackage contents:"
        Get-ChildItem dist/WindowsAiMic -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
      
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WindowsAiMic-Release
        path: dist/WindowsAiMic/
        
    - name: Create Release ZIP
      if: startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        Compress-Archive -Path dist/WindowsAiMic/* -DestinationPath WindowsAiMic-Release.zip
      
    - name: Upload Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: WindowsAiMic-Release.zip
